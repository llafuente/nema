"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Parameter_1 = require("../Parameter");
const fs = require("fs");
const path = require("path");
const CommonGenerator = require("./CommonGenerator");
function mkdirSafe(folder) {
    try {
        fs.mkdirSync(folder);
    }
    catch (e) {
        if (e.code != "EEXIST")
            throw e;
    }
}
class Express {
    static generate(api, dstPath, lint) {
        api.sort();
        // create generation paths
        mkdirSafe(path.join(dstPath));
        mkdirSafe(path.join(dstPath, "src"));
        mkdirSafe(path.join(dstPath, "src/models"));
        mkdirSafe(path.join(dstPath, "src/mongoose"));
        mkdirSafe(path.join(dstPath, "src/routes"));
        // generate all models
        CommonGenerator.models(api, dstPath);
        // copy raw files (those that don't need to be generated)
        CommonGenerator.copyCommonTemplates(dstPath);
        fs.copyFileSync(path.join(process.cwd(), "templates", "node-express", ".gitignore"), path.join(dstPath, ".gitignore"));
        fs.copyFileSync(path.join(process.cwd(), "templates", "node-express", "nodemon.json"), path.join(dstPath, "nodemon.json"));
        fs.copyFileSync(path.join(process.cwd(), "templates", "node-express", "package.json"), path.join(dstPath, "package.json"));
        fs.copyFileSync(path.join(process.cwd(), "templates", "node-express", "tsconfig.json"), path.join(dstPath, "tsconfig.json"));
        Express.routesFile(api, path.join(dstPath, "src/routes.ts"));
        api.eachMethod((method, name) => {
            Express.routeFile(api, method, path.join(dstPath, `src/routes/${method.operationId}.ts`));
        });
        Express.indexFile(api, path.join(dstPath, "index.ts"));
        /*
            Angular5Client.apiFile(api, path.join(dstPath, `src/${api.apiName}.ts`));
        
            Angular5Client.moduleFile(api, path.join(dstPath, `index.ts`));
        
            Angular5Client.packageJSONFile(api, path.join(dstPath, `package.json`));
        
        */
        CommonGenerator.pretty(dstPath);
        // this may take a long time...
        if (lint) {
            CommonGenerator.lint(dstPath);
        }
    }
    static header(api) {
        return "// DO NOT EDIT THIS FILE\n";
    }
    static templates(dstPath) {
        ["Cast.ts", "CommonException.ts", "Random.ts"].forEach((filename) => {
            fs.copyFileSync(path.join(process.cwd(), "templates", "node-express", filename), path.join(dstPath, filename));
        });
    }
    static indexFile(api, filename) {
        CommonGenerator.writeModificableTemplate(filename, Express.index(api));
    }
    static routesFile(api, filename) {
        fs.writeFileSync(filename, Express.routes(api));
    }
    static routeFile(api, method, filename) {
        CommonGenerator.writeModificableTemplate(filename, Express.route(api, method));
    }
    static packageJSONFile(api, filename) {
        fs.writeFileSync(filename, Express.packageJSON(api));
    }
    static routes(api) {
        const imports = [];
        const s = [];
        imports.push(`import * as express from "express";`);
        api.eachMethod((method, operationId) => {
            imports.push(`import { ${method.operationId}Route } from "./routes/${method.operationId}";`);
            s.push(`r.${method.verb.toLowerCase()}(${method.operationId}Route);`);
        });
        return `${imports.join("\n")}

export function routes(app: express.Application) {
  const r: express.Router = express.Router();
  app.use(${JSON.stringify(api.basePath)}, r);

  ${s.join("\n")}
}
`;
    }
    static route(api, method) {
        const getParams = ["req", "res", "next"];
        const params = [];
        let imports = [];
        method.eachParam((p) => {
            params.push(`${p.name}: ${p.type.toTypeScriptType()}`);
            if (!p.type.isPrimitive()) {
                imports.push(`import { ${p.type.toBaseType()} } from "../models/${p.type.toBaseType()}";`);
            }
            switch (p.in) {
                case Parameter_1.ParameterType.BODY:
                    getParams.push(p.type.getParser(`req.body`));
                    break;
                case Parameter_1.ParameterType.COOKIE:
                    getParams.push(p.type.getParser(`req.cookies.${p.name} || null`));
                    break;
                case Parameter_1.ParameterType.HEADER:
                    getParams.push(p.type.getParser(`req.header(${JSON.stringify(p.name)})`));
                    break;
                case Parameter_1.ParameterType.PATH:
                    getParams.push(p.type.getParser(`req.param(${JSON.stringify(p.name)})`));
                    break;
                case Parameter_1.ParameterType.QUERY:
                    getParams.push(p.type.getParser(`req.query.${p.name} || null`));
                    break;
            }
        });
        imports = imports.filter((value, index, self) => {
            return self.indexOf(value) === index;
        });
        return {
            tokens: ["custom-imports", "method-body", "extras"],
            template: `import * as express from "express";
import { Request, Response } from "../";
import { Cast } from "../Cast";
${imports.join("\n")}

// this zones are safe to edit
//<custom-imports>
//</custom-imports>
export function ${method.operationId}Route(req: Request, res: Response, next: express.NextFunction) {
  ${method.operationId}(${getParams.join(", ")});
}
export function ${method.operationId}(req: Request, res: Response, next: express.NextFunction, ${params.join(", ")}) {
//<method-body>
//</method-body>
}
//<extras>
//</extras>
`
        };
    }
    static index(api) {
        return {
            tokens: ["express-configuration", "request", "response"],
            template: `import * as express from "express";
import * as path from "path";
import * as bodyParser from "body-parser";
import { CommonException } from "./src/CommonException";
import { NotFound } from "./src/Errors";

const cors = require("cors");
const morgan = require("morgan");

import { routes } from "./src/routes";

// nodemon kill
process.on("SIGUSR2", () => {
  process.exit(0);
});

export const app = express();
//<express-configuration>
app.set("mongodb", process.env.MONGO_URI || "mongodb://127.0.0.1:27017/test");

// false to disable
app.set("cors", {
  origin: "http://localhost:3003",
  credentials: true,
})
//</express-configuration>

// declare our own interface for request to save our variables
export class Upload {
  fieldname: string;
  originalname: string;
  encoding: string;
  mimetype: string;
  size: string;
  destination: string;
  filename: string;
  path: string;
  buffer: string;
}

export interface Request extends express.Request {
  file: Upload;
  files: { [s: string]: Upload };
  //<request>
  //</request>
}

export interface Response extends express.Response {
  //<response>
  //</response>
}

const mongoose = require("mongoose");
mongoose.Promise = require("bluebird");
mongoose.set("debug", true);

mongoose.connect(
  app.get("mongodb"),
  {
    promiseLibrary: require("bluebird"),
    useMongoClient: true,
  },
  function(err) {
    if (err) {
      throw err;
    }

    console.log("connected to mongodb:", app.get("mongodb"));
  },
);

app.use(morgan("tiny"));
if (app.get("cors")) {
  app.use(
    cors(app.get("cors")),
  );
}

// use query json body parser
app.use(bodyParser.json());
// use query string parser
app.use(
  bodyParser.urlencoded({
    extended: true,
  }),
);

routes(app);

app.use((req: Request, res: express.Response, next: express.NextFunction) => {
  res.status(404).json(new CommonException(404, "not-found", "Not found", null, null, Date.now()));
});

app.use((err: Error, req: Request, res: express.Response, next: express.NextFunction) => {
  console.error("Error handler: ", err);

  if (err instanceof NotFound) {
    res.status(404).json(new CommonException(404, "not-found", "Not found", null, null, Date.now()));
  }

  if (!(err instanceof CommonException)) {
    console.warn("Unhandled error thrown", err);
  }

  res.status(404).json(err);
});

if (process.env.NODE_ENV !== "test") {
  const port: number = process.env.PORT ? parseInt(process.env.PORT, 10) : 8080;
  console.log("listening at: 0.0.0.0:" + port);
  app.listen(port, "0.0.0.0");
}
`
        };
    }
    static packageJSON(api) {
        return JSON.stringify({
            "name": api.angularClientNodeModuleName,
            "version": api.version,
            "description": api.description,
            "author": {
                "name": api.authorName,
                "email": api.authorEmail,
                "url": api.authorURL,
            },
            "peerDependencies": {
                "@angular/core": ">=5.2.0",
                "typescript": "*"
            },
            "main": "./index.ts"
        }, null, 2);
    }
}
exports.Express = Express;
//# sourceMappingURL=Express.js.map